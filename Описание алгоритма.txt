Алгоритм выбора Блоками Индикации (БИ) нового мастера в случае потери соединения с текущем мастером - Блоком Контроля (БК) или БИ в режиме мастера (БИМ).

Краткое введение. БИ и БК взаимодействуют в сети Ethernet на основе проприетарного протокола (CBP). Базой алгоритма являются широковещательные сообщения Ethernet и сравнение MAC адресов отдельных БИ.

Протокол представляет собой набор следующих сообщений(запросов и ответов). Запросы являются широковещательными, ответы - персональными на адрес источника запроса.

- Режим мастера (БК или БИМ):

Запросы:
"Нужны исполнители" (НИ)
"Запрос данных с датчиков" (ЗДЗ)
"Примите данные для отображения"

Ответы:
"Я - мастер" (ЯМ)

- Режим исполнителя (БИ в режиме исполнителя):

Запросы:
"Нужен мастер" (НМ)

Ответы:
"Я - исполнитель" (ЯИ)
"Запрошенные данные с датчиков" (ЗДО)

Состояния блоков.

БК может находиться в двух состояниях:
"Жду исполнителей"
"Мастер"

БИ может находиться в четырех состояниях (два для БИМ + два для БИ):
"Жду исполнителей"
"Мастер"
"Жду мастера"
"Исполнитель"

Непосредственно алгоритм.

1) В случае потери соединения с мастером (в нашем случае это будет отсутствие запроса ЗДЗ в течении интервала - 5 минут по заданию, сокращён до 30 секунд в реализованном эмуляторе для облегчения отладки), БИ переходит в режим "Жду мастера", отправляет запрос НМ, устанавливает флаг "Я - старший" (ЯС), сбрасывает счётчик БИ в сети, устанавливает таймер ожидания отклика мастера.

2) В режиме "Жду мастера" обрабатываются запросы НМ от других БИ, а именно сравниваются MAC адреса и если хоть один адрес больше нашего, сбрасывается флаг ЯС. Также увеличивается счётчик БИ на каждый запрос НМ.

3) В случае получения ответа ЯМ, БИ переходит в режим "Исполнитель", сбрасывается таймер ожидания отклика мастреа и устанавливает таймер ожидания запроса ЗДЗ от мастера. Аналогичен ответ на запрос НИ, плюс отправляется ответ ЯИ.

4) Если срабатывает таймер ожидания отклика мастера, то есть в сети нет мастера, переходим на пункт (1) (всего N попыток). Если это попытка N+1, тогда проверяем флаг ЯС и счетчик БИ в сети. Нулевое значение счётчика (означает, что этот БИ единственный в сети) или установленный флаг (означает, что в сети нет БИ с адресом больше нашего), инициирует переход в режим БИМ "Жду исполнителей" с отправкой запроса НИ.
  
5) Получение ответа ЯИ переводит БИМ в режим "Мастер" с последующей переодической отправкой запросов ЗДЗ.

Таким образом при наличии хотя бы одного БИ в сети, алгоритм гарантирует наличие мастера.  

Также реализован алгоритм разрешения конфликтных ситуаций, могу описать дополнительно по запросу (если необходимо). 